#!/bin/bash

# uncomment the next line to see exactly what happens
# set -x

# elements of bad style: lots of cloned code.

# command line inputs:
# $1 : benchmark list filename

#JOOSDIR=/home/user/hendren/JOOS1.1
#JJOOSDIR=/home/user/hendren/SableCC/JJOOS3
#SABLECCDIR=/home/user/hendren/SableCC/sablecc-3-beta.3
#WIGDIR=/home/user/hendren/WIG

PATH=${PATH}:${HOME}/bin:$JOOSDIR/bin:$WIGDIR/bin:${JOOSDIR}/a-
CLASSPATH=.:$JOOSDIR/jasmin/classes:$JOOSDIR/jooslib.jar
root_dir=`pwd`


for bench in `cat $1 | cut -f1 | xargs echo`

  do
  bench_dir=`grep $bench $1 | cut -f2`
  bench_main=`grep $bench $1 | cut -f3`
  echo BENCHMARK ${bench} ${bench_dir} ${bench_main}
  
  cd ${bench_dir}
  
  find . -type f -name '*.class' | xargs rm -f
  find . -type f -name '*.j' | xargs rm -f

  rm -rf javac-classes
  rm -rf aminus-classes
  rm -rf aplus-classes
  mkdir javac-classes

  echo "  compiling with javac                     (.java --> .class)"
  javac -Xlint:none -classpath ${CLASSPATH} -d javac-classes/ *.java
  javac -Xlint:none -classpath ${CLASSPATH} -d . *.java

  cp -R javac-classes aminus-classes
  cp -R javac-classes aplus-classes
  cd javac-classes
  echo "  disassembling with d-java                (.class --> .j)"
  echo "  disassembling with d-java                (.class --> .sj)"
  for file in *.class
    do
    short=`echo ${file} | sed -e 's/.class//'`
    d-java-${OSTYPE} -o jasmin ${short} > ${short}.j
    d-java-${OSTYPE} -b -o jasmin ${short} > ${short}.sj
  done
  cd ..

  echo "  compiling with a-joos                    (.java --> .j)"
# ls *.java *.joos ${JOOSDIR}/Extern/*.joos \
  ls *.java *.joos 2> /dev/null \
      | xargs ${JOOSDIR}/bin/joosa- 
  mv *.j aminus-classes
  cd aminus-classes
  rm *.class
  echo "  assembling with jasmin                   (.j --> .class)"
  java -classpath ${CLASSPATH} jasmin.Main *.j > jasmin.out
  echo "  disassembling with d-java                (.class --> .sj)"
  for file in *.class
    do
    short=`echo ${file} | sed -e 's/.class//'`
    d-java-${OSTYPE} -b -o jasmin ${short} > ${short}.sj
  done
  cd ..

  echo "  compiling with a+joos                    (.java --> .j)"
# ls *.java *.joos ${JOOSDIR}/Extern/*.joos \
  ls *.java *.joos ${JOOSDIR}/joos/extern/*.joos 2> /dev/null \
      | xargs ${JOOSDIR}/bin/joosa+-$OSTYPE
  mv *.j aplus-classes
  cd aplus-classes
  rm *.class
  echo "  assembling with jasmin                   (.j --> .class)"
  java -classpath ${CLASSPATH} jasmin.Main *.j > jasmin.out
  echo "  disassembling with d-java                (.class --> .sj)"
  for file in *.class
    do
    short=`echo ${file} | sed -e 's/.class//'`
    d-java-${OSTYPE} -b -o jasmin ${short} > ${short}.sj
  done
  cd ..

  find . -type f -name '*.class' | grep -v -E 'classes/' | xargs rm -f

  CLASSFILENAME=${bench_main}.class
  cd javac-classes
  if [ -e ${CLASSFILENAME} ]; then
  	  echo "  running javac benchmark" 	      
          cp ../* . 2>/dev/null #copy resources
  	  java -cp ${CLASSPATH} ${bench_main} < ../in1 > out.javac
  	  diff -u ../out1 out.javac
  else
      echo "  NO ${bench_main}.class generated by javac, skip testing"	
  fi
  cd ..

  cd aminus-classes
  if [ -e ${CLASSFILENAME} ]; then
	  echo "  running a-joos benchmark"
          cp ../* . 2>/dev/null #copy resources
	  java -cp ${CLASSPATH} ${bench_main} < ../in1 > out.a-joos
	  diff -u ../out1 out.a-joos
  else 
      echo "  NO ${bench_main}.class generated by a-joos, skip testing"	
  fi
  cd ..
  
  cd aplus-classes
  if [ -e ${CLASSFILENAME} ]; then
	  echo "  running a+joos benchmark"
          cp ../* . 2>/dev/null #copy resources
	  java -cp ${CLASSPATH} ${bench_main} < ../in1 > out.a+joos
	  diff -u ../out1 out.a+joos
  else
      echo "  NO ${bench_main}.class generated by a+joos, skip testing"	
  fi
  cd ..
    
  cd ${root_dir}
  echo
done
